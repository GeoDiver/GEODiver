var GD;GD||(GD={}),function(){GD.setUpValidatorDefaults=function(){$.validator.addMethod("geoDb",function(e){return/^GDS\d\d\d\d?$/.test(e)},"Please enter a valid GEO dataset accession number (in the format GDSxxxx)."),$.validator.setDefaults({errorClass:"invalid",validClass:"valid",errorPlacement:function(e,t){$(t).closest("form").find("label[for='"+t.attr("id")+"']").attr("data-error",e.text())}})},GD.loadGeoDbValidation=function(){"use strict";$("#load_geo_db").validate({rules:{geo_db:{geoDb:!0,required:!0}},submitHandler:function(e){var t=$("input[name=geo_db]").val();$("#model_header_text").text("Loading GEO Dataset: "+t),$("#model_text").text("This should take a few seconds. Please leave this page open"),$("#loading_modal").openModal({dismissible:!1}),$.ajax({type:"POST",url:"/load_geo_db",data:$("#load_geo_db").serialize(),success:function(e){$(".card-action").remove(),$("#results_section").empty(),$(".load_geo_db_btn").removeClass("btn-large"),$(e).insertAfter("#load_geo_card"),$("#geo_db_summary").html(e),$("#geo_db_summary").show(),$(".adv_param_collapsible").collapsible(),$("input:radio[name=factor]:first").attr("checked",!0),$("#"+$("input:radio[name=factor]:first").attr("id")+"_select").show(),GD.addFactorToggle(),$("select").material_select(),GD.addDataSetInfo(),GD.analyseValidation(),$("#loading_modal").closeModal()},error:function(e,t){GD.ajaxError()}})}})},GD.analyseValidation=function(){"use strict";$("#analyse").validate({rules:{},submitHandler:function(e){var t=$("input[name=geo_db]").val();$("#model_header_text").text("Analysing GEO Dataset: "+t),$("#model_text").text("This should take a few minutes. Please leave this page open"),$("#loading_modal").openModal({dismissible:!1}),$.ajax({type:"POST",url:"/analyse",data:$("#analyse").serialize(),success:function(e){$("#results_section").html(e),$("#results_section").show(),$("#results_tabs").tabs(),GD.createPlots(),$(".materialboxed").materialbox(),$("#loading_modal").closeModal()},error:function(e,t){GD.ajaxError()}})}})},GD.ajaxError=function(){var t;500==e.status||400==e.status?(t=e.responseText,$("#results_section").show(),$("#results_section").html(t),$("#loading_modal").closeModal()):(t=e.responseText,$("#results_section").show(),$("#results_section").html("There seems to be an unidentified Error."),$("#loading_modal").closeModal())},GD.createPlots=function(){jsonFile=$("#DGEA").data("results-json"),$.getJSON(jsonFile,function(e){pcaPlot=GD.createPCAPLOT(e.pc.cumVar,e.pc.expVar,e.pc.pcnames),volcanoPlot=GD.createVolcanoPlot(e.vol.logFC,e.vol.pVal,e.vol.genes)}),window.onresize=function(){Plotly.Plots.resize(pcaPlot),Plotly.Plots.resize(volcanoPlot)}},GD.createPCAPLOT=function(e,t,a){var o={x:a,y:e,type:"scatter",name:"Cumulative PCA"},l={x:a,y:t,type:"scatter",name:"PCA"},s=[o,l],n={legend:{x:0,y:100,traceorder:"normal"}},r=100,i=Plotly.d3.select("#PCA_plot").style({width:r+"%","margin-left":(100-r)/2+"%"}),d=i.node();return Plotly.plot(d,s,n),d},GD.createVolcanoPlot=function(e,t,a){var o={x:e,y:t,text:a,mode:"markers",type:"scatter",name:"volcano_plot",marker:{size:7.5}},l=[o],s={xaxis:{range:[-1.15,1.15]},yaxis:{range:[5,28]},hovermode:"closest",xaxis:{title:"Log 2 Fold Change"},yaxis:{title:"-Log10(P Value)"}},n=100,r=Plotly.d3.select("#volcano_plot").style({width:n+"%","margin-left":(100-n)/2+"%"}),i=r.node();return Plotly.plot(i,l,s),i},GD.addFactorToggle=function(){$("input:radio[name=factor]").click(function(){var e="#"+$(this).attr("id")+"_select";"#"+$(".select_factors:visible").attr("id")!==e&&($(".select_factors").hide(),$(e).show())})},GD.addDataSetInfo=function(){var e=$("input[name=geo_db]").val(),t="GeoDiver/DBs/"+e+".json";$.getJSON(t,function(e){$("#dataset_accession").text(e.Accession),$("#dataset_title").text(e.Title),$("#dataset_summary").text(e.Description),$("#dataset_organism").text(e.Sample_Organism),$("#dataset_summary").text(e.Description),$("#dataset_citation").text(e.Reference)})},GD.addUserDropDown=function(){$(".dropdown-button").dropdown({inDuration:300,outDuration:225,hover:!0,belowOrigin:!0,alignment:"right"})}}(),function(e){e(function(){e(".button-collapse").sideNav(),e(".parallax").parallax(),e("select").material_select(),GD.setUpValidatorDefaults(),GD.loadGeoDbValidation(),GD.addUserDropDown()})}(jQuery);